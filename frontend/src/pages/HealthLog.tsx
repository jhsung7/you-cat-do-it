import { useState, useRef, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { useTranslation } from "react-i18next";
import { useCatStore } from "../store/catStore";
import { useHealthStore } from "../store/healthStore";
import { startVoiceRecognition } from "../services/speech";
import { parseHealthLogFromVoice } from "../services/gemini";
import type { HealthLog } from "../types";

interface QuickLogSettings {
    mealAmount: number;
    waterAmount: number;
    litterCount: number;
}

function HealthLogPage() {
    const navigate = useNavigate();
    const { t, i18n } = useTranslation();
    const { selectedCat } = useCatStore();
    const { addHealthLog, getRecentLogs } = useHealthStore();

    const [viewMode, setViewMode] = useState<'calendar' | 'list'>('list');
    const [selectedDate, setSelectedDate] = useState(new Date());
    const [showForm, setShowForm] = useState(false);
    const [showSettings, setShowSettings] = useState(false);
    const [isListening, setIsListening] = useState(false);
    const [isProcessing, setIsProcessing] = useState(false);
    const [voiceMessage, setVoiceMessage] = useState("");
    const recognitionRef = useRef<SpeechRecognition | null>(null);

    // Îπ†Î•∏ ÏûÖÎ†• Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
    const [quickLogSettings, setQuickLogSettings] = useState<QuickLogSettings>(() => {
        const saved = localStorage.getItem('quickLogSettings');
        return saved ? JSON.parse(saved) : {
            mealAmount: 50,
            waterAmount: 50,
            litterCount: 1,
        };
    });

    const [formData, setFormData] = useState({
        date: new Date().toISOString().split("T")[0],
        time: new Date().toTimeString().slice(0, 5),
        type: 'general' as HealthLog['type'],
        foodAmount: "",
        waterAmount: "",
        litterCount: "",
        activityLevel: "normal" as "active" | "normal" | "lazy",
        mood: "normal" as "happy" | "normal" | "sad" | "angry",
        notes: "",
    });

    // ÏÑ§Ï†ï Ï†ÄÏû•
    const saveSettings = () => {
        localStorage.setItem('quickLogSettings', JSON.stringify(quickLogSettings));
        setShowSettings(false);
        setVoiceMessage(i18n.language === "ko" ? "‚úÖ ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!" : "‚úÖ Settings saved!");
        setTimeout(() => setVoiceMessage(""), 2000);
    };

    // üöÄ Îπ†Î•∏ ÏûÖÎ†• Ìï®Ïàò
    const quickLog = (type: HealthLog['type']) => {
        if (!selectedCat) {
            alert(t("healthLog.selectCatFirst"));
            return;
        }

        const now = new Date();
        const log: HealthLog = {
            id: crypto.randomUUID(),
            catId: selectedCat.id,
            date: now.toISOString().split("T")[0],
            time: now.toTimeString().slice(0, 5),
            timestamp: now.getTime(),
            type: type,
            foodAmount: type === 'meal' ? quickLogSettings.mealAmount : undefined,
            waterAmount: type === 'water' ? quickLogSettings.waterAmount : undefined,
            litterCount: type === 'litter' ? quickLogSettings.litterCount : undefined,
            activityLevel: "normal",
            mood: "normal",
            notes: "",
        };

        console.log("üöÄ Quick log:", log);
        addHealthLog(log);

        // ÏÑ±Í≥µ Î©îÏãúÏßÄ
        let typeName = "";
        if (i18n.language === "ko") {
            typeName = type === 'meal' ? 'ÏãùÏÇ¨' 
                     : type === 'water' ? 'Î¨º' 
                     : type === 'litter' ? 'Î∞∞Î≥Ä' 
                     : 'Í∏∞Î°ù';
        } else {
            typeName = type === 'meal' ? 'Meal' 
                     : type === 'water' ? 'Water' 
                     : type === 'litter' ? 'Litter' 
                     : 'Record';
        }
        
        const message = i18n.language === "ko" 
            ? `‚úÖ ${typeName} Ï†ÄÏû• ÏôÑÎ£å!`
            : `‚úÖ ${typeName} logged successfully!`;
        
        setVoiceMessage(message);
        setTimeout(() => setVoiceMessage(""), 2000);
    };

    // üé§ ÏùåÏÑ± ÏûÖÎ†•
    const handleVoiceInput = () => {
        if (!selectedCat) {
            setVoiceMessage(t("healthLog.selectCatFirst"));
            setTimeout(() => setVoiceMessage(""), 3000);
            return;
        }

        setIsListening(true);
        setVoiceMessage(
            i18n.language === "ko"
                ? "üé§ Îì£Í≥† ÏûàÏäµÎãàÎã§... (ÎßêÏîÄÌï¥Ï£ºÏÑ∏Ïöî)"
                : "üé§ Listening... (Please speak)"
        );

        const recognition = startVoiceRecognition(
            async (transcript) => {
                setIsListening(false);
                recognitionRef.current = null;
                setIsProcessing(true);
                setVoiceMessage(
                    i18n.language === "ko"
                        ? `üìù "${transcript}" - AIÍ∞Ä Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...`
                        : `üìù "${transcript}" - AI is analyzing...`
                );

                const parsed = await parseHealthLogFromVoice(
                    transcript,
                    selectedCat.name,
                    i18n.language as "ko" | "en"
                );

                setIsProcessing(false);

                if (parsed.success) {
                    setFormData((prev) => ({
                        ...prev,
                        foodAmount: parsed.foodAmount !== undefined ? String(parsed.foodAmount) : prev.foodAmount,
                        waterAmount: parsed.waterAmount !== undefined ? String(parsed.waterAmount) : prev.waterAmount,
                        litterCount: parsed.litterCount !== undefined ? String(parsed.litterCount) : prev.litterCount,
                        activityLevel: parsed.activityLevel || prev.activityLevel,
                        mood: parsed.mood || prev.mood,
                        notes: parsed.notes || prev.notes,
                    }));

                    setVoiceMessage(
                        i18n.language === "ko"
                            ? "‚úÖ ÏûêÎèôÏúºÎ°ú ÏûÖÎ†•ÎêòÏóàÏäµÎãàÎã§! ÌôïÏù∏ ÌõÑ Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî."
                            : "‚úÖ Auto-filled successfully! Please review and save."
                    );

                    setShowForm(true);
                    setTimeout(() => setVoiceMessage(""), 5000);
                } else {
                    setVoiceMessage(
                        (i18n.language === "ko" ? "‚ùå ÏùåÏÑ±ÏùÑ Ïù¥Ìï¥ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§. " : "‚ùå Failed to understand. ") +
                        (i18n.language === "ko" ? "ÏàòÎèôÏúºÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî." : "Please use manual input.")
                    );
                    setTimeout(() => setVoiceMessage(""), 5000);
                }
            },
            (error) => {
                setIsListening(false);
                recognitionRef.current = null;
                setVoiceMessage(error + " " + (i18n.language === "ko" ? "ÏàòÎèô ÏûÖÎ†•ÏùÑ ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî." : "Please use manual input."));
                setTimeout(() => setVoiceMessage(""), 5000);
            },
            i18n.language as "ko" | "en"
        );

        recognitionRef.current = recognition;
    };

    const handleStopListening = () => {
        if (recognitionRef.current) {
            recognitionRef.current.stop();
            recognitionRef.current = null;
            setIsListening(false);
            setVoiceMessage(i18n.language === "ko" ? "‚èπÔ∏è ÏùåÏÑ± ÏûÖÎ†•Ïù¥ Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§." : "‚èπÔ∏è Voice input stopped.");
            setTimeout(() => setVoiceMessage(""), 3000);
        }
    };

    const handleFormSubmit = (e: React.FormEvent) => {
        e.preventDefault();

        if (!selectedCat) return;

        try {
            const dateTime = new Date(`${formData.date}T${formData.time}`);
            const log: HealthLog = {
                id: crypto.randomUUID(),
                catId: selectedCat.id,
                date: formData.date,
                time: formData.time,
                timestamp: dateTime.getTime(),
                type: formData.type,
                foodAmount: formData.foodAmount ? Number(formData.foodAmount) : undefined,
                waterAmount: formData.waterAmount ? Number(formData.waterAmount) : undefined,
                litterCount: formData.litterCount ? Number(formData.litterCount) : undefined,
                activityLevel: formData.activityLevel,
                mood: formData.mood,
                notes: formData.notes,
            };

            console.log("‚úÖ Saving log:", log);
            addHealthLog(log);

            setShowForm(false);
            setFormData({
                date: new Date().toISOString().split("T")[0],
                time: new Date().toTimeString().slice(0, 5),
                type: 'general',
                foodAmount: "",
                waterAmount: "",
                litterCount: "",
                activityLevel: "normal",
                mood: "normal",
                notes: "",
            });

            setVoiceMessage(i18n.language === "ko" ? "‚úÖ Ï†ÄÏû• ÏôÑÎ£å!" : "‚úÖ Saved!");
            setTimeout(() => setVoiceMessage(""), 2000);
        } catch (error) {
            console.error("‚ùå Error saving health log:", error);
            alert(i18n.language === "ko" ? "Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§." : "Error saving data.");
        }
    };

    if (!selectedCat) {
        return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center max-w-md">
                    <div className="text-6xl mb-4">üê±</div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">
                        {t("healthLog.selectCatFirst")}
                    </h2>
                    <p className="text-gray-600 mb-6">
                        {t("healthLog.selectCatDescription")}
                    </p>
                    <button
                        onClick={() => navigate("/")}
                        className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                    >
                        {t("healthLog.backButton")}
                    </button>
                </div>
            </div>
        );
    }

    const activityOptions = [
        { value: "active", label: t("healthLog.active") },
        { value: "normal", label: t("healthLog.normal") },
        { value: "lazy", label: t("healthLog.lazy") },
    ];

    const moodEmojis: Record<"happy" | "normal" | "sad" | "angry", string> = {
        happy: "üòä",
        normal: "üòê",
        sad: "üò¢",
        angry: "üò†",
    };

    const moodOptions: Array<{
        value: "happy" | "normal" | "sad" | "angry";
        label: string;
        emoji: string;
    }> = [
            { value: "happy", label: t("healthLog.moodHappy"), emoji: "üòä" },
            { value: "normal", label: t("healthLog.moodNormal"), emoji: "üòê" },
            { value: "sad", label: t("healthLog.moodSad"), emoji: "üò¢" },
            { value: "angry", label: t("healthLog.moodAngry"), emoji: "üò†" },
        ];

    const catLogs = getRecentLogs(selectedCat.id, 365);

    // Ï∫òÎ¶∞ÎçîÏö©: ÎÇ†ÏßúÎ≥ÑÎ°ú Î°úÍ∑∏ Í∑∏Î£πÌôî
    const logsByDate = catLogs.reduce((acc, log) => {
        if (!acc[log.date]) {
            acc[log.date] = [];
        }
        acc[log.date].push(log);
        return acc;
    }, {} as Record<string, HealthLog[]>);

    // ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÏùò Î°úÍ∑∏
    const selectedDateStr = selectedDate.toISOString().split('T')[0];
    const selectedDateLogs = logsByDate[selectedDateStr] || [];

    // Ï∫òÎ¶∞Îçî Î†åÎçîÎßÅ
    const renderCalendar = () => {
        const year = selectedDate.getFullYear();
        const month = selectedDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();

        const days = [];
        for (let i = 0; i < startDayOfWeek; i++) {
            days.push(<div key={`empty-${i}`} className="p-2"></div>);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const hasLogs = logsByDate[dateStr] && logsByDate[dateStr].length > 0;
            const isSelected = dateStr === selectedDateStr;

            days.push(
                <button
                    key={day}
                    onClick={() => setSelectedDate(new Date(year, month, day))}
                    className={`p-2 rounded-lg transition ${
                        isSelected 
                            ? 'bg-blue-500 text-white' 
                            : hasLogs 
                            ? 'bg-green-100 text-gray-800 hover:bg-green-200' 
                            : 'text-gray-600 hover:bg-gray-100'
                    }`}
                >
                    <div className="text-sm font-medium">{day}</div>
                    {hasLogs && (
                        <div className="text-xs mt-1">
                            {logsByDate[dateStr].length}Í∞ú
                        </div>
                    )}
                </button>
            );
        }

        return days;
    };

    return (
        <div className="min-h-screen bg-gray-50">
            {/* ========== Ìó§Îçî ========== */}
            <div className="bg-white shadow-sm border-b sticky top-0 z-10">
                <div className="max-w-4xl mx-auto px-4 py-4">
                    <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-4">
                            <button onClick={() => navigate("/")} className="text-blue-600 hover:text-blue-700">
                                ‚Üê {t("healthLog.backButton")}
                            </button>
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">
                                    {selectedCat?.name} {t("healthLog.title")}
                                </h1>
                                <p className="text-sm text-gray-600">
                                    {selectedCat?.breed} ¬∑ {selectedCat?.weight}kg
                                </p>
                            </div>
                        </div>
                        <button
                            onClick={() => setShowSettings(true)}
                            className="p-2 text-gray-600 hover:text-gray-800"
                            title={i18n.language === "ko" ? "ÏÑ§Ï†ï" : "Settings"}
                        >
                            ‚öôÔ∏è
                        </button>
                    </div>

                    {/* Î∑∞ Î™®Îìú Ï†ÑÌôò */}
                    <div className="flex gap-2 mb-3">
                        <button
                            onClick={() => setViewMode('list')}
                            className={`flex-1 px-4 py-2 rounded-lg transition ${
                                viewMode === 'list'
                                    ? 'bg-blue-500 text-white'
                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                        >
                            üìù {i18n.language === 'ko' ? 'Î™©Î°ù' : 'List'}
                        </button>
                        <button
                            onClick={() => setViewMode('calendar')}
                            className={`flex-1 px-4 py-2 rounded-lg transition ${
                                viewMode === 'calendar'
                                    ? 'bg-blue-500 text-white'
                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                        >
                            üìÖ {i18n.language === 'ko' ? 'Ï∫òÎ¶∞Îçî' : 'Calendar'}
                        </button>
                    </div>

                    {/* Îπ†Î•∏ ÏûÖÎ†• Î≤ÑÌäºÎì§ */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                        <button
                            onClick={() => quickLog('meal')}
                            className="flex items-center justify-center gap-1 px-3 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 transition text-sm"
                        >
                            <span className="text-lg">üçΩÔ∏è</span>
                            <span>{i18n.language === 'ko' ? 'ÏãùÏÇ¨' : 'Meal'}</span>
                        </button>
                        <button
                            onClick={() => quickLog('water')}
                            className="flex items-center justify-center gap-1 px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition text-sm"
                        >
                            <span className="text-lg">üíß</span>
                            <span>{i18n.language === 'ko' ? 'Î¨º' : 'Water'}</span>
                        </button>
                        <button
                            onClick={() => quickLog('litter')}
                            className="flex items-center justify-center gap-1 px-3 py-2 text-white rounded-md hover:opacity-90 transition text-sm"
                            style={{ backgroundColor: '#8B4513' }}
                        >
                            <span className="text-lg">üöΩ</span>
                            <span>{i18n.language === 'ko' ? 'Î∞∞Î≥Ä' : 'Litter'}</span>
                        </button>
                        <button
                            onClick={() => setShowForm(true)}
                            className="flex items-center justify-center gap-1 px-3 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition text-sm"
                        >
                            <span className="text-lg">üìù</span>
                            <span>{i18n.language === 'ko' ? 'ÏÉÅÏÑ∏ÏûÖÎ†•' : 'Detail'}</span>
                        </button>
                    </div>

                    {/* ÏùåÏÑ±ÏûÖÎ†• */}
                    <div className="flex gap-2">
                        {isListening ? (
                            <button
                                onClick={handleStopListening}
                                className="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition animate-pulse"
                            >
                                ‚èπÔ∏è {i18n.language === "ko" ? "Î©àÏ∂§" : "Stop"}
                            </button>
                        ) : (
                            <button
                                onClick={handleVoiceInput}
                                disabled={isProcessing}
                                className={`flex-1 px-4 py-2 rounded-lg transition ${
                                    isProcessing ? "bg-gray-400 cursor-not-allowed" : "bg-green-500 hover:bg-green-600"
                                } text-white`}
                            >
                                {isProcessing
                                    ? "‚è≥ " + (i18n.language === "ko" ? "Î∂ÑÏÑù Ï§ë..." : "Processing...")
                                    : "üé§ " + (i18n.language === "ko" ? "ÏùåÏÑ± ÏûÖÎ†•" : "Voice Input")}
                            </button>
                        )}
                    </div>

                    {voiceMessage && (
                        <div
                            className={`mt-2 px-4 py-2 rounded-lg text-sm ${
                                voiceMessage.includes("‚úÖ")
                                    ? "bg-green-50 text-green-700"
                                    : voiceMessage.includes("‚ùå")
                                    ? "bg-red-50 text-red-700"
                                    : "bg-blue-50 text-blue-700"
                            }`}
                        >
                            {voiceMessage}
                        </div>
                    )}
                </div>
            </div>

            {/* ========== Î©îÏù∏ ÏΩòÌÖêÏ∏† ========== */}
            <div className="max-w-4xl mx-auto px-4 py-6">
                {viewMode === 'list' ? (
                    // Î™©Î°ù Î∑∞
                    catLogs.length === 0 ? (
                        <div className="bg-white rounded-lg shadow-md p-12 text-center">
                            <div className="text-6xl mb-4">üìù</div>
                            <p className="text-xl text-gray-600 mb-2">{t("healthLog.noLogs")}</p>
                            <p className="text-gray-500 mb-6">
                                {i18n.language === 'ko' ? 'ÏúÑÏùò Î≤ÑÌäºÏúºÎ°ú Îπ†Î•¥Í≤å Í∏∞Î°ùÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî!' : 'Start logging with the buttons above!'}
                            </p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {catLogs.map((log) => (
                                <div key={log.id} className="bg-white rounded-lg shadow-md p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <div>
                                            <h3 className="text-lg font-bold text-gray-800">
                                                {new Date(log.date).toLocaleDateString(
                                                    i18n.language === "ko" ? "ko-KR" : "en-US",
                                                    { year: "numeric", month: "long", day: "numeric" }
                                                )}
                                            </h3>
                                            <p className="text-sm text-gray-500">{log.time}</p>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-2xl">
                                                {log.type === 'meal' && 'üçΩÔ∏è'}
                                                {log.type === 'water' && 'üíß'}
                                                {log.type === 'litter' && 'üöΩ'}
                                                {log.type === 'weight' && '‚öñÔ∏è'}
                                                {log.type === 'symptom' && '‚ö†Ô∏è'}
                                                {log.type === 'general' && 'üìù'}
                                            </span>
                                            <span className="text-2xl">{moodEmojis[log.mood ?? "normal"]}</span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-3 gap-4">
                                        {log.foodAmount !== undefined && (
                                            <div>
                                                <p className="text-sm text-gray-600">{t("healthLog.food")}</p>
                                                <p className="text-xl font-bold text-gray-800">{log.foodAmount}g</p>
                                            </div>
                                        )}
                                        {log.waterAmount !== undefined && (
                                            <div>
                                                <p className="text-sm text-gray-600">{t("healthLog.water")}</p>
                                                <p className="text-xl font-bold text-gray-800">{log.waterAmount}ml</p>
                                            </div>
                                        )}
                                        {log.litterCount !== undefined && (
                                            <div>
                                                <p className="text-sm text-gray-600">{t("healthLog.litter")}</p>
                                                <p className="text-xl font-bold text-gray-800">
                                                    {log.litterCount}{t("healthLog.times")}
                                                </p>
                                            </div>
                                        )}
                                    </div>

                                    {log.notes && (
                                        <div className="border-t mt-4 pt-4">
                                            <p className="text-sm text-gray-600 mb-1">{t("healthLog.memo")}</p>
                                            <p className="text-gray-800">{log.notes}</p>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )
                ) : (
                    // Ï∫òÎ¶∞Îçî Î∑∞
                    <div className="bg-white rounded-lg shadow-md p-6">
                        {/* Ïõî ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
                        <div className="flex items-center justify-between mb-4">
                            <button
                                onClick={() => setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth() - 1, 1))}
                                className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200"
                            >
                                ‚Üê
                            </button>
                            <h2 className="text-xl font-bold">
                                {selectedDate.toLocaleDateString(i18n.language === "ko" ? "ko-KR" : "en-US", { year: "numeric", month: "long" })}
                            </h2>
                            <button
                                onClick={() => setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 1))}
                                className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200"
                            >
                                ‚Üí
                            </button>
                        </div>

                        {/* ÏöîÏùº Ìó§Îçî */}
                        <div className="grid grid-cols-7 gap-2 mb-2">
                            {[i18n.language === 'ko' ? 'Ïùº' : 'Sun', 
                              i18n.language === 'ko' ? 'Ïõî' : 'Mon', 
                              i18n.language === 'ko' ? 'Ìôî' : 'Tue', 
                              i18n.language === 'ko' ? 'Ïàò' : 'Wed', 
                              i18n.language === 'ko' ? 'Î™©' : 'Thu', 
                              i18n.language === 'ko' ? 'Í∏à' : 'Fri', 
                              i18n.language === 'ko' ? 'ÌÜ†' : 'Sat'].map(day => (
                                <div key={day} className="text-center text-sm font-medium text-gray-600 p-2">
                                    {day}
                                </div>
                            ))}
                        </div>

                        {/* Ï∫òÎ¶∞Îçî Í∑∏Î¶¨Îìú */}
                        <div className="grid grid-cols-7 gap-2 mb-6">
                            {renderCalendar()}
                        </div>

                        {/* ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÏùò Î°úÍ∑∏ */}
                        {selectedDateLogs.length > 0 && (
                            <div className="border-t pt-4">
                                <h3 className="text-lg font-bold mb-4">
                                    {selectedDate.toLocaleDateString(i18n.language === "ko" ? "ko-KR" : "en-US", { 
                                        month: "long", 
                                        day: "numeric" 
                                    })} {i18n.language === 'ko' ? 'Í∏∞Î°ù' : 'Logs'}
                                </h3>
                                <div className="space-y-3">
                                    {selectedDateLogs.map(log => (
                                        <div key={log.id} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                            <span className="text-2xl">
                                                {log.type === 'meal' && 'üçΩÔ∏è'}
                                                {log.type === 'water' && 'üíß'}
                                                {log.type === 'litter' && 'üöΩ'}
                                                {log.type === 'weight' && '‚öñÔ∏è'}
                                                {log.type === 'symptom' && '‚ö†Ô∏è'}
                                                {log.type === 'general' && 'üìù'}
                                            </span>
                                            <div className="flex-1">
                                                <p className="text-sm text-gray-600">{log.time}</p>
                                                <div className="flex gap-3 text-sm">
                                                    {log.foodAmount && <span>üçΩÔ∏è {log.foodAmount}g</span>}
                                                    {log.waterAmount && <span>üíß {log.waterAmount}ml</span>}
                                                    {log.litterCount && <span>üöΩ {log.litterCount}Ìöå</span>}
                                                </div>
                                                {log.notes && <p className="text-sm text-gray-700 mt-1">{log.notes}</p>}
                                            </div>
                                            <span className="text-xl">{moodEmojis[log.mood ?? "normal"]}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>

            {/* ========== ÏÑ§Ï†ï Î™®Îã¨ ========== */}
            {showSettings && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">
                            ‚öôÔ∏è {i18n.language === 'ko' ? 'Îπ†Î•∏ ÏûÖÎ†• ÏÑ§Ï†ï' : 'Quick Log Settings'}
                        </h2>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    üçΩÔ∏è {i18n.language === 'ko' ? 'ÏãùÏÇ¨ Í∏∞Î≥∏Îüâ (g)' : 'Default Meal Amount (g)'}
                                </label>
                                <input
                                    type="number"
                                    value={quickLogSettings.mealAmount}
                                    onChange={(e) => setQuickLogSettings({ ...quickLogSettings, mealAmount: Number(e.target.value) })}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    min="1"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    üíß {i18n.language === 'ko' ? 'Î¨º Í∏∞Î≥∏Îüâ (ml)' : 'Default Water Amount (ml)'}
                                </label>
                                <input
                                    type="number"
                                    value={quickLogSettings.waterAmount}
                                    onChange={(e) => setQuickLogSettings({ ...quickLogSettings, waterAmount: Number(e.target.value) })}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    min="1"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    üöΩ {i18n.language === 'ko' ? 'Î∞∞Î≥Ä Í∏∞Î≥∏ ÌöüÏàò' : 'Default Litter Count'}
                                </label>
                                <input
                                    type="number"
                                    value={quickLogSettings.litterCount}
                                    onChange={(e) => setQuickLogSettings({ ...quickLogSettings, litterCount: Number(e.target.value) })}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    min="1"
                                />
                            </div>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={() => setShowSettings(false)}
                                className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                            >
                                {i18n.language === 'ko' ? 'Ï∑®ÏÜå' : 'Cancel'}
                            </button>
                            <button
                                onClick={saveSettings}
                                className="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                            >
                                {i18n.language === 'ko' ? 'Ï†ÄÏû•' : 'Save'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* ========== ÏÉÅÏÑ∏ ÏûÖÎ†• Ìèº (ÌÜµÌï©) ========== */}
            {showForm && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">
                                {i18n.language === 'ko' ? 'ÏÉÅÏÑ∏ Í∏∞Î°ù ÏûÖÎ†•' : 'Detailed Log'}
                            </h2>

                            <form onSubmit={handleFormSubmit} className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            {t("healthLog.date")}
                                        </label>
                                        <input
                                            type="date"
                                            value={formData.date}
                                            onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            {i18n.language === 'ko' ? 'ÏãúÍ∞Ñ' : 'Time'}
                                        </label>
                                        <input
                                            type="time"
                                            value={formData.time}
                                            onChange={(e) => setFormData({ ...formData, time: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        {i18n.language === 'ko' ? 'Í∏∞Î°ù Ïú†Ìòï' : 'Record Type'}
                                    </label>
                                    <select
                                        value={formData.type}
                                        onChange={(e) => setFormData({ ...formData, type: e.target.value as HealthLog['type'] })}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                    >
                                        <option value="general">üìù {i18n.language === 'ko' ? 'Ï¢ÖÌï©' : 'General'}</option>
                                        <option value="meal">üçΩÔ∏è {i18n.language === 'ko' ? 'ÏãùÏÇ¨' : 'Meal'}</option>
                                        <option value="water">üíß {i18n.language === 'ko' ? 'ÏàòÎ∂Ñ' : 'Water'}</option>
                                        <option value="litter">üöΩ {i18n.language === 'ko' ? 'Î∞∞Î≥Ä' : 'Litter'}</option>
                                        <option value="weight">‚öñÔ∏è {i18n.language === 'ko' ? 'Ï≤¥Ï§ë' : 'Weight'}</option>
                                        <option value="symptom">‚ö†Ô∏è {i18n.language === 'ko' ? 'Ï¶ùÏÉÅ' : 'Symptom'}</option>
                                    </select>
                                </div>

                                <div className="grid grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            {t("healthLog.food")} (g)
                                        </label>
                                        <input
                                            type="number"
                                            value={formData.foodAmount}
                                            onChange={(e) => setFormData({ ...formData, foodAmount: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            {t("healthLog.water")} (ml)
                                        </label>
                                        <input
                                            type="number"
                                            value={formData.waterAmount}
                                            onChange={(e) => setFormData({ ...formData, waterAmount: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            {t("healthLog.litter")}
                                        </label>
                                        <input
                                            type="number"
                                            value={formData.litterCount}
                                            onChange={(e) => setFormData({ ...formData, litterCount: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        />
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            {t("healthLog.activity")}
                                        </label>
                                        <select
                                            value={formData.activityLevel}
                                            onChange={(e) => setFormData({ ...formData, activityLevel: e.target.value as "active" | "normal" | "lazy" })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        >
                                            {activityOptions.map((option) => (
                                                <option key={option.value} value={option.value}>
                                                    {option.label}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            {t("healthLog.mood")}
                                        </label>
                                        <select
                                            value={formData.mood}
                                            onChange={(e) => setFormData({ ...formData, mood: e.target.value as "happy" | "normal" | "sad" | "angry" })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        >
                                            {moodOptions.map((option) => (
                                                <option key={option.value} value={option.value}>
                                                    {option.emoji} {option.label}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        {t("healthLog.memo")}
                                    </label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        rows={3}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        placeholder={t("healthLog.memo")}
                                    />
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button
                                        type="button"
                                        onClick={() => setShowForm(false)}
                                        className="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                                    >
                                        {t("healthLog.cancel")}
                                    </button>
                                    <button
                                        type="submit"
                                        className="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                                    >
                                        {t("healthLog.save")}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

export default HealthLogPage;