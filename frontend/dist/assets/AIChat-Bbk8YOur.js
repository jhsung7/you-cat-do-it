import{d as A,u as F,a as J,r as d,j as e}from"./index-ff_Z8oB1.js";import{u as $}from"./healthStore-DqCSjk-d.js";import{c as T}from"./gemini-CtJ_B-Ee.js";function P(){const S=A(),{t:r,i18n:n}=F(),{cats:D,selectedCat:i}=J(),{getRecentLogs:I,getAnomalies:M}=$(),[b,g]=d.useState([{role:"assistant",content:r("aiChat.greeting"),timestamp:new Date}]),[m,h]=d.useState(""),[p,v]=d.useState(!1),[j,U]=d.useState(null),[Q,u]=d.useState(!1),[N,w]=d.useState([]),f=d.useRef(crypto.randomUUID()),R=t=>{try{const s="ai-chat-conversations",a=localStorage.getItem(s),o=a?JSON.parse(a):[],l=t.slice(1);if(l.length===0)return;const c=o.findIndex(O=>O.id===f.current),x={id:f.current,timestamp:new Date().toISOString(),catId:i==null?void 0:i.id,catName:i==null?void 0:i.name,messages:l};c>=0?o[c]=x:o.push(x);const y=o.slice(-10);localStorage.setItem(s,JSON.stringify(y))}catch(s){console.error("Failed to save conversation:",s)}},k=()=>{try{const s=localStorage.getItem("ai-chat-conversations"),a=s?JSON.parse(s):[];w(a.reverse())}catch(t){console.error("Failed to load conversations:",t),w([])}},q=t=>{try{const s=t.messages.map(o=>({...o,timestamp:new Date(o.timestamp)})),a=[{role:"assistant",content:r("aiChat.greeting"),timestamp:new Date},...s];g(a),f.current=t.id,u(!1)}catch(s){console.error("Failed to load conversation:",s)}},K=t=>{try{const s="ai-chat-conversations",a=localStorage.getItem(s),l=(a?JSON.parse(a):[]).filter(c=>c.id!==t);localStorage.setItem(s,JSON.stringify(l)),k()}catch(s){console.error("Failed to delete conversation:",s)}},L=()=>{g([{role:"assistant",content:r("aiChat.greeting"),timestamp:new Date}]),f.current=crypto.randomUUID(),u(!1)};d.useEffect(()=>{g([{role:"assistant",content:r("aiChat.greeting"),timestamp:new Date}])},[n.language,r]);const C=async()=>{if(!m.trim())return;const t={role:"user",content:m,timestamp:new Date};g(s=>[...s,t]),h(""),v(!0);try{const s=i?I(i.id,7):[],a=i?M(i.id):[],o=b.slice(1).map(x=>({role:x.role,content:x.content})),l=await T(m,i,s,n.language,o,a),c={role:"assistant",content:l.answer,timestamp:new Date,reasoning:l.reasoning,confidence:l.confidence,followUpQuestions:l.followUpQuestions,sources:l.sources};g(x=>{const y=[...x,c];return setTimeout(()=>R(y),0),y})}catch(s){console.error("AI Chat Error:",s);const a={role:"assistant",content:r("aiChat.errorMessage"),timestamp:new Date};g(o=>[...o,a])}finally{v(!1)}},H=t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),C())},E=[r("aiChat.quickQuestions.q1"),r("aiChat.quickQuestions.q2"),r("aiChat.quickQuestions.q3"),r("aiChat.quickQuestions.q4")];return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white shadow-sm border-b sticky top-0 z-10",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>S("/"),className:"text-blue-600 hover:text-blue-700",children:["â† ",r("aiChat.backButton")]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:r("aiChat.title")}),i&&e.jsx("p",{className:"text-sm text-gray-600",children:r("aiChat.consultingWith",{catName:i.name})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:L,className:"px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-medium",children:["ðŸ†• ",n.language==="ko"?"ìƒˆ ëŒ€í™”":"New Chat"]}),e.jsxs("button",{onClick:()=>{k(),u(!0)},className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm font-medium",children:["ðŸ“œ ",n.language==="ko"?"ëŒ€í™” ê¸°ë¡":"History"]})]})]}),!i&&D.length>0&&e.jsx("div",{className:"mt-2",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["ðŸ’¡ ",r("aiChat.noCatWarning")]})})]})}),e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-6",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-md flex flex-col",style:{height:"calc(100vh - 250px)"},children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[b.map((t,s)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[80%] rounded-lg px-4 py-3 ${t.role==="user"?"bg-blue-500 text-white":"bg-gray-100 text-gray-800"}`,children:[e.jsx("p",{className:"whitespace-pre-wrap break-words",children:t.content}),t.role==="assistant"&&t.confidence&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:n.language==="ko"?"í™•ì‹ ë„:":"Confidence:"}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${t.confidence==="high"?"bg-green-100 text-green-700":t.confidence==="medium"?"bg-yellow-100 text-yellow-700":"bg-orange-100 text-orange-700"}`,children:n.language==="ko"?t.confidence==="high"?"ë†’ìŒ":t.confidence==="medium"?"ì¤‘ê°„":"ë‚®ìŒ":t.confidence==="high"?"High":t.confidence==="medium"?"Medium":"Low"})]}),e.jsx("p",{className:`text-xs mt-1 ${t.role==="user"?"text-blue-100":"text-gray-500"}`,children:t.timestamp.toLocaleTimeString(n.language==="ko"?"ko-KR":"en-US",{hour:"2-digit",minute:"2-digit"})})]})}),t.role==="assistant"&&t.reasoning&&e.jsx("div",{className:"flex justify-start mt-1",children:e.jsxs("div",{className:"max-w-[80%]",children:[e.jsxs("button",{onClick:()=>U(j===s?null:s),className:"text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1",children:[e.jsx("span",{children:j===s?"â–¼":"â–¶"}),e.jsx("span",{children:n.language==="ko"?"ì§„ë‹¨ ê³¼ì • ë³´ê¸°":"View diagnostic reasoning"})]}),j===s&&e.jsxs("div",{className:"mt-2 bg-purple-50 rounded-lg px-3 py-2 border border-purple-200",children:[e.jsxs("p",{className:"text-xs font-medium text-purple-900 mb-1",children:["ðŸ§  ",n.language==="ko"?"ë‚´ë¶€ ì¶”ë¡  ê³¼ì •":"Internal Reasoning"]}),e.jsx("p",{className:"text-xs text-purple-800 whitespace-pre-wrap",children:t.reasoning})]})]})}),t.role==="assistant"&&t.followUpQuestions&&t.followUpQuestions.length>0&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"max-w-[80%] space-y-2",children:[e.jsxs("p",{className:"text-xs text-gray-500 px-2",children:["ðŸ’¬ ",n.language==="ko"?"í›„ì† ì§ˆë¬¸":"Follow-up questions"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.followUpQuestions.map((a,o)=>e.jsx("button",{onClick:()=>h(a),className:"text-sm px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg border border-blue-200 transition",children:a},o))})]})}),t.role==="assistant"&&t.sources&&t.sources.length>0&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"max-w-[60%] rounded-lg border border-amber-200 bg-amber-50/60 px-2.5 py-2",children:[e.jsxs("p",{className:"text-[10px] font-semibold text-amber-900 mb-1",children:["ðŸ“š ",n.language==="ko"?"ì°¸ê³  ìžë£Œ":"References"]}),e.jsx("ul",{className:"space-y-1",children:t.sources.map((a,o)=>e.jsxs("li",{className:"text-[10px] text-amber-900 leading-snug",children:[e.jsx("span",{className:"font-medium",children:a.content}),a.date&&e.jsxs("span",{className:"ml-1 text-amber-700 italic",children:["(",a.date,")"]}),a.url&&e.jsx("a",{href:a.url,target:"_blank",rel:"noreferrer",className:"ml-1 text-blue-600 underline",children:n.language==="ko"?"ì›ë¬¸":"Source"})]},o))})]})})]},s)),p&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 rounded-lg px-4 py-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})})})]}),b.length===1&&e.jsxs("div",{className:"px-6 pb-4",children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["ðŸ’¬ ",r("aiChat.frequentQuestions")]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:E.map((t,s)=>e.jsx("button",{onClick:()=>h(t),className:"text-left text-sm px-3 py-2 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition",children:t},s))})]}),e.jsx("div",{className:"border-t p-4",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("textarea",{value:m,onChange:t=>h(t.target.value),onKeyPress:H,placeholder:r("aiChat.placeholder"),className:"flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",rows:2,disabled:p}),e.jsx("button",{onClick:C,disabled:!m.trim()||p,className:`px-6 py-3 rounded-lg font-medium transition ${m.trim()&&!p?"bg-blue-500 text-white hover:bg-blue-600":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,children:r("aiChat.sendButton")})]})})]})}),Q&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"px-6 py-4 border-b flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800",children:["ðŸ“œ ",n.language==="ko"?"ëŒ€í™” ê¸°ë¡":"Conversation History"]}),e.jsx("button",{onClick:()=>u(!1),className:"text-gray-500 hover:text-gray-700 text-2xl",children:"Ã—"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:N.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("p",{className:"text-lg",children:n.language==="ko"?"ì €ìž¥ëœ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤":"No saved conversations"}),e.jsx("p",{className:"text-sm mt-2",children:n.language==="ko"?"AIì™€ ëŒ€í™”ë¥¼ ì‹œìž‘í•˜ë©´ ìžë™ìœ¼ë¡œ ì €ìž¥ë©ë‹ˆë‹¤":"Conversations are automatically saved when you chat"})]}):e.jsx("div",{className:"space-y-3",children:N.map(t=>{const s=t.messages.find(c=>c.role==="user"),a=s?s.content.slice(0,60)+(s.content.length>60?"...":""):n.language==="ko"?"(ë©”ì‹œì§€ ì—†ìŒ)":"(No messages)",l=new Date(t.timestamp).toLocaleDateString(n.language==="ko"?"ko-KR":"en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return e.jsx("div",{className:"border rounded-lg p-4 hover:bg-gray-50 transition",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:t.catName||(n.language==="ko"?"ê³ ì–‘ì´ ì—†ìŒ":"No cat")}),e.jsx("span",{className:"text-xs text-gray-500",children:l})]}),e.jsx("p",{className:"text-sm text-gray-600 truncate",children:a}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:[t.messages.length," ",n.language==="ko"?"ê°œ ë©”ì‹œì§€":"messages"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>q(t),className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-sm whitespace-nowrap",children:n.language==="ko"?"ë¶ˆëŸ¬ì˜¤ê¸°":"Load"}),e.jsx("button",{onClick:()=>{window.confirm(n.language==="ko"?"ì´ ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?":"Delete this conversation?")&&K(t.id)},className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm",children:"ðŸ—‘ï¸"})]})]})},t.id)})})}),e.jsx("div",{className:"px-6 py-4 border-t bg-gray-50",children:e.jsx("button",{onClick:()=>u(!1),className:"w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition",children:n.language==="ko"?"ë‹«ê¸°":"Close"})})]})})]})}export{P as default};
